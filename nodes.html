<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="å®‰å…¨å¯é çš„ä»£ç†è®¢é˜…æœåŠ¡">
    <meta name="keywords" content="è®¢é˜…,ä»£ç†,èŠ‚ç‚¹,Clash,Shadowrocket">
    <meta name="author" content="é­”æ³•è¡¥ç»™ç«™">
    
    <!-- å†…å®¹å®‰å…¨ç­–ç•¥ -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' https:;
                   script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline';
                   style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
                   font-src 'self' https://fonts.gstatic.com;
                   connect-src 'self' https://api.github.com https://fastly.jsdelivr.net;
                   frame-ancestors 'none';
                   form-action 'self'">
    
    <title>é­”æ³•è¡¥ç»™ç«™ - å®‰å…¨æé€Ÿè‡ªåŠ¨åŒ–</title>
    
    <!-- åŠ è½½å¤±è´¥æ—¶é™çº§å¤„ç† -->
    <script>
        // å¼ºåˆ¶HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            location.replace(`https://${location.hostname}${location.pathname}${location.search}`);
        }
        
        // èµ„æºåŠ è½½å¤±è´¥å¤„ç†
        window.addEventListener('error', function(e) {
            console.warn('èµ„æºåŠ è½½å¤±è´¥:', e.target.src || e.target.href);
        }, true);
    </script>
    
    <!-- Tailwind CSS with fallback -->
    <link rel="stylesheet" 
          href="https://cdn.tailwindcss.com"
          onerror="console.warn('Tailwind CSSåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ ·å¼');">
    
    <!-- å¤‡ç”¨æœ¬åœ°æ ·å¼ -->
    <style id="fallback-styles">
        /* åŸºç¡€æ ·å¼ï¼Œå½“TailwindåŠ è½½å¤±è´¥æ—¶ä½¿ç”¨ */
        body { margin: 0; padding: 1rem; background-color: #fff5f7; }
        .container { max-width: 28rem; margin: 0 auto; }
        .card { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .btn { display: block; width: 100%; padding: 1rem; border-radius: 1rem; text-align: center; 
               margin-bottom: 1rem; font-weight: bold; border: none; cursor: pointer; transition: all 0.3s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, #007aff, #5856d6); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #fb923c, #ea580c); color: white; }
        .btn-success { background: linear-gradient(135deg, #4ade80, #16a34a); color: white; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .opacity-80 { opacity: 0.8; }
    </style>
    
    <!-- Googleå­—ä½“ï¼Œä¼˜åŒ–åŠ è½½ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Inter:wght@400;600;700&display=swap" 
          rel="stylesheet"
          onerror="console.warn('Googleå­—ä½“åŠ è½½å¤±è´¥');">
    
    <style>
        :root {
            --color-primary: #ff6b81;
            --color-secondary: #ffb7c5;
            --color-success: #4ade80;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-info: #3b82f6;
        }
        
        body { 
            background-color: #fff5f7; 
            font-family: 'ZCOOL KuaiLe', 'Inter', sans-serif; 
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        /* å¯è®¿é—®æ€§ï¼šé”®ç›˜ç„¦ç‚¹æ ·å¼ */
        *:focus {
            outline: 3px solid var(--color-info);
            outline-offset: 2px;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid var(--color-secondary);
            border-radius: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007aff, #ff6b81, #4ade80);
        }
        
        .sakura-bg { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: -1;
        }
        
        /* å‘¼å¸ç¯ç‰¹æ•ˆ - æ”¹è¿›ç‰ˆ */
        @keyframes breath {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(255, 107, 129, 0.2), 0 2px 4px rgba(0,0,0,0.1);
                transform: translateY(0);
            }
            50% { 
                box-shadow: 0 0 20px rgba(255, 107, 129, 0.4), 0 4px 8px rgba(0,0,0,0.15);
                transform: translateY(-2px);
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .recommend-active { 
            animation: breath 2s infinite ease-in-out;
            border: 2px solid white;
            position: relative;
        }
        
        .recommend-active::after {
            content: 'âœ¨ æ¨è';
            position: absolute;
            top: -10px;
            right: 10px;
            background: var(--color-primary);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            animation: pulse 1.5s infinite;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% { transform: scale(0, 0); opacity: 0.5; }
            100% { transform: scale(20, 20); opacity: 0; }
        }
        
        .btn-shadowrocket { 
            background: linear-gradient(135deg, #007aff, #5856d6);
            color: white;
        }
        
        .btn-clash { 
            background: linear-gradient(135deg, #fb923c, #ea580c);
            color: white;
        }
        
        .btn-clash-backup { 
            background: linear-gradient(135deg, #4ade80, #16a34a);
            color: white;
        }
        
        .btn-copy { 
            background: white;
            color: #ff8fa3;
            border: 2px solid #ffb7c5;
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .status-online { background-color: var(--color-success); }
        .status-offline { background-color: var(--color-danger); }
        .status-warning { background-color: var(--color-warning); }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 107, 129, 0.3);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 640px) {
            .glass-card {
                border-radius: 1.5rem;
                padding: 1.5rem !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* æš—è‰²æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e5e5e5;
            }
            
            .glass-card {
                background: rgba(30, 30, 30, 0.95);
                border-color: #444;
            }
            
            .btn-copy {
                background: #2d2d2d;
                color: #ff8fa3;
                border-color: #444;
            }
        }
    </style>
</head>
<body>
    <!-- æ¨±èŠ±èƒŒæ™¯ -->
    <canvas id="sakura-canvas" class="sakura-bg" 
            aria-hidden="true" 
            role="presentation"></canvas>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="max-w-md w-full mx-auto">
        <main>
            <div class="glass-card p-8 shadow-2xl">
                <!-- ç”¨æˆ·å¤´åƒ -->
                <div class="w-20 h-20 rounded-full border-4 border-white shadow-lg overflow-hidden mx-auto mb-4">
                    <img src="tx.jpg" 
                         class="w-full h-full object-cover" 
                         alt="ç”¨æˆ·å¤´åƒ"
                         loading="lazy"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSI0MCIgY3k9IjQwIiByPSI0MCIgZmlsbD0iI2ZmNmI4MSIvPjwvc3ZnPg=='">
                </div>

                <!-- æ ‡é¢˜ -->
                <h1 class="text-2xl font-bold text-center text-[#ff6b81] mb-2">
                    âœ¨ é­”æ³•è¡¥ç»™ç«™
                </h1>
                
                <!-- å±å¹•é˜…è¯»å™¨ä¸“ç”¨æ ‡é¢˜ -->
                <h2 class="sr-only">ä»£ç†è®¢é˜…æœåŠ¡é¢æ¿</h2>

                <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="flex justify-center gap-3 mb-6 mt-3 flex-wrap">
                    <span id="node-count" 
                          class="bg-pink-100 text-[#ff6b81] text-xs px-3 py-1.5 rounded-full border border-pink-200 flex items-center">
                        <span class="loading mr-2" id="node-loading"></span>
                        <span id="node-count-text">æ¸…ç‚¹èŠ‚ç‚¹ä¸­...</span>
                    </span>
                    
                    <span id="update-time" 
                          class="bg-blue-100 text-blue-600 text-xs px-3 py-1.5 rounded-full border border-blue-200 flex items-center">
                        <span class="status-dot status-online mr-2"></span>
                        <span id="update-time-text">åŒæ­¥ä¸­...</span>
                    </span>
                    
                    <span id="server-status" 
                          class="bg-green-100 text-green-600 text-xs px-3 py-1.5 rounded-full border border-green-200 flex items-center">
                        <span class="status-dot status-online mr-2"></span>
                        <span>æœåŠ¡å™¨æ­£å¸¸</span>
                    </span>
                </div>

                <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                <div class="space-y-4" role="group" aria-label="è®¢é˜…æ“ä½œ">
                    <!-- iOSæŒ‰é’® -->
                    <button id="btn-ios"
                            class="btn btn-shadowrocket w-full font-bold py-4 rounded-2xl shadow-lg flex flex-col items-center justify-center"
                            aria-label="ä¸€é”®å¯¼å…¥å°ç«ç®­ï¼Œæ”¯æŒShadowrocketå’ŒQuantumult X">
                        <span class="text-lg">ğŸš€ ä¸€é”®å¯¼å…¥å°ç«ç®­ (iOS)</span>
                        <span class="text-xs opacity-80 font-normal mt-1">
                            æ”¯æŒ Shadowrocket / Quantumult X
                        </span>
                    </button>

                    <!-- AndroidæŒ‰é’® -->
                    <button id="btn-android"
                            class="btn btn-clash w-full font-bold py-4 rounded-2xl shadow-lg flex flex-col items-center justify-center"
                            aria-label="ä¸€é”®å¯¼å…¥Clashï¼Œæ¨èå®‰å“å’ŒWindowsç”¨æˆ·ä½¿ç”¨">
                        <span class="text-lg">ğŸ”¥ ä¸€é”®å¯¼å…¥ Clash</span>
                        <span class="text-xs opacity-80 font-normal mt-1">
                            æ¨èå®‰å“/Windowsç”¨æˆ·ä½¿ç”¨
                        </span>
                    </button>

                    <!-- å¤‡ç”¨æŒ‰é’® -->
                    <button id="btn-backup"
                            class="btn btn-clash-backup w-full font-bold py-4 rounded-2xl shadow-lg text-sm"
                            aria-label="å¯¼å…¥å¤±è´¥æ—¶ä½¿ç”¨çš„å¤‡ç”¨çº¿è·¯">
                        ğŸ”„ å¯¼å…¥å¤±è´¥è¯·ç‚¹æ­¤ (å¤‡ç”¨çº¿è·¯)
                    </button>

                    <!-- å¤åˆ¶é“¾æ¥æŒ‰é’® -->
                    <button id="copyBtn"
                            class="btn btn-copy w-full font-bold py-4 rounded-2xl transition-all text-sm"
                            aria-label="å¤åˆ¶è®¢é˜…é“¾æ¥åˆ°å‰ªè´´æ¿">
                        ğŸ“‹ ä»…å¤åˆ¶è®¢é˜…é“¾æ¥
                    </button>
                </div>
                
                <!-- è®¢é˜…é“¾æ¥æ˜¾ç¤º -->
                <div class="mt-6 p-3 bg-gray-50 rounded-xl border border-gray-200 hidden" id="link-display">
                    <p class="text-xs text-gray-600 mb-2">è®¢é˜…é“¾æ¥ï¼š</p>
                    <div class="flex items-center gap-2">
                        <code id="subscription-link" class="flex-1 text-xs p-2 bg-white rounded border break-all"></code>
                        <button id="copy-link-again" class="text-xs px-3 py-2 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 transition-colors">
                            å¤åˆ¶
                        </button>
                    </div>
                </div>

                <!-- ä¿¡æ¯åŒºåŸŸ -->
                <footer class="mt-8 px-4 text-center border-t border-dashed border-pink-100 pt-6">
                    <p class="text-xs text-gray-500 mb-2">
                        <span id="cdn-status">ğŸŸ¢ CDNåŠ é€Ÿå·²å¯ç”¨</span>
                        <span class="mx-2">â€¢</span>
                        <span id="connection-status">åŠ å¯†è¿æ¥å·²å»ºç«‹</span>
                    </p>
                    
                    <div class="mt-4 text-xs text-gray-400 space-y-1">
                        <p>Â© 2025 é£çš„é­”æ³•å°å±‹ | è‡ªåŠ¨è¡¥è´§ç³»ç»Ÿ</p>
                        <p class="text-[10px]">
                            <a href="#privacy" class="text-gray-400 hover:text-gray-600 underline" id="privacy-link">
                                éšç§æ”¿ç­–
                            </a>
                            <span class="mx-2">|</span>
                            <a href="#tos" class="text-gray-400 hover:text-gray-600 underline" id="tos-link">
                                æœåŠ¡æ¡æ¬¾
                            </a>
                        </p>
                    </div>
                </footer>
            </div>
        </main>
    </div>

    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-50">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 glass-card">
            <h3 id="modal-title" class="text-xl font-bold text-[#ff6b81] mb-4"></h3>
            <p id="modal-content" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="modal-close" class="px-4 py-2 text-gray-600 hover:text-gray-800">å…³é—­</button>
                <button id="modal-confirm" class="px-4 py-2 bg-[#ff6b81] text-white rounded-lg hover:bg-[#ff5570]">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬ -->
    <script>
        // é…ç½®é¡¹ - å¯ä¿®æ”¹
        const Config = {
            GITHUB_USER: "feng-180",
            GITHUB_REPO: "feng-180.github.io",
            SUBSCRIPTION_FILE: "sub_all.txt",
            
            // ç¼“å­˜è®¾ç½®ï¼ˆæ¯«ç§’ï¼‰
            CACHE_DURATION: 5 * 60 * 1000, // 5åˆ†é’Ÿ
            NODE_COUNT_CACHE_KEY: 'node_count_cache',
            UPDATE_TIME_CACHE_KEY: 'update_time_cache',
            
            // APIç«¯ç‚¹
            getSubscriptionUrl() {
                return `https://fastly.jsdelivr.net/gh/${this.GITHUB_USER}/${this.GITHUB_REPO}@main/${this.SUBSCRIPTION_FILE}`;
            },
            
            getGitHubApiUrl() {
                return `https://api.github.com/repos/${this.GITHUB_USER}/${this.GITHUB_REPO}/commits?path=${this.SUBSCRIPTION_FILE}&per_page=1`;
            }
        };

        // çŠ¶æ€ç®¡ç†
        const State = {
            isLoading: false,
            subscriptionUrl: Config.getSubscriptionUrl(),
            nodeCount: 0,
            lastUpdate: null,
            isOnline: navigator.onLine,
            
            updateNodeCount(count) {
                this.nodeCount = count;
                localStorage.setItem(Config.NODE_COUNT_CACHE_KEY, JSON.stringify({
                    count,
                    timestamp: Date.now()
                }));
            },
            
            updateLastUpdate(time) {
                this.lastUpdate = time;
                localStorage.setItem(Config.UPDATE_TIME_CACHE_KEY, JSON.stringify({
                    time,
                    timestamp: Date.now()
                }));
            },
            
            getCachedNodeCount() {
                const cached = localStorage.getItem(Config.NODE_COUNT_CACHE_KEY);
                if (!cached) return null;
                
                const { count, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < Config.CACHE_DURATION) {
                    return count;
                }
                return null;
            },
            
            getCachedUpdateTime() {
                const cached = localStorage.getItem(Config.UPDATE_TIME_CACHE_KEY);
                if (!cached) return null;
                
                const { time, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp < Config.CACHE_DURATION) {
                    return time;
                }
                return null;
            }
        };

        // DOMå…ƒç´ å¼•ç”¨
        const Elements = {
            // çŠ¶æ€æ˜¾ç¤º
            nodeCount: document.getElementById('node-count'),
            nodeCountText: document.getElementById('node-count-text'),
            nodeLoading: document.getElementById('node-loading'),
            updateTime: document.getElementById('update-time-text'),
            serverStatus: document.getElementById('server-status'),
            
            // æŒ‰é’®
            btnIos: document.getElementById('btn-ios'),
            btnAndroid: document.getElementById('btn-android'),
            btnBackup: document.getElementById('btn-backup'),
            copyBtn: document.getElementById('copyBtn'),
            copyLinkAgain: document.getElementById('copy-link-again'),
            
            // é“¾æ¥æ˜¾ç¤º
            linkDisplay: document.getElementById('link-display'),
            subscriptionLink: document.getElementById('subscription-link'),
            
            // çŠ¶æ€æŒ‡ç¤ºå™¨
            cdnStatus: document.getElementById('cdn-status'),
            connectionStatus: document.getElementById('connection-status'),
            
            // æ¨¡æ€æ¡†
            modalContainer: document.getElementById('modal-container'),
            modalTitle: document.getElementById('modal-title'),
            modalContent: document.getElementById('modal-content'),
            modalClose: document.getElementById('modal-close'),
            modalConfirm: document.getElementById('modal-confirm')
        };

        // å·¥å…·å‡½æ•°
        const Utils = {
            // å®‰å…¨Base64ç¼–ç 
            encodeBase64(str) {
                try {
                    return btoa(encodeURIComponent(str));
                } catch (e) {
                    console.error('Base64ç¼–ç å¤±è´¥:', e);
                    return '';
                }
            },

            // æ ¼å¼åŒ–æ—¶é—´
            formatTime(date) {
                if (!date) return 'æœªçŸ¥æ—¶é—´';
                
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'åˆšåˆš';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
                return `${Math.floor(diff / 86400000)}å¤©å‰`;
            },

            // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
            async copyToClipboard(text) {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } else {
                        // é™çº§æ–¹æ¡ˆ
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        const success = document.execCommand('copy');
                        document.body.removeChild(textArea);
                        return success;
                    }
                } catch (error) {
                    console.error('å¤åˆ¶å¤±è´¥:', error);
                    return false;
                }
            },

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage(message, type = 'info') {
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                // ç§»é™¤ç°æœ‰æ¶ˆæ¯
                const existing = document.querySelector('.message-toast');
                if (existing) existing.remove();
                
                // åˆ›å»ºæ–°æ¶ˆæ¯
                const toast = document.createElement('div');
                toast.className = `message-toast fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300 translate-x-full`;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                // åŠ¨ç”»æ˜¾ç¤º
                requestAnimationFrame(() => {
                    toast.style.transform = 'translateX(0)';
                });
                
                // 3ç§’åæ¶ˆå¤±
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            // éªŒè¯è®¢é˜…é“¾æ¥
            async validateSubscription(url) {
                try {
                    const response = await fetch(url, { 
                        method: 'HEAD',
                        cache: 'no-cache'
                    });
                    return response.ok;
                } catch (error) {
                    console.warn('è®¢é˜…é“¾æ¥éªŒè¯å¤±è´¥:', error);
                    return false;
                }
            },

            // é˜²æŠ–å‡½æ•°
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // èŠ‚æµå‡½æ•°
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }
        };

        // æ¨¡æ€æ¡†ç®¡ç†
        const Modal = {
            show(title, content, onConfirm = null) {
                Elements.modalTitle.textContent = title;
                Elements.modalContent.textContent = content;
                Elements.modalContainer.classList.remove('hidden');
                
                // è®¾ç½®ç¡®è®¤æŒ‰é’®å›è°ƒ
                if (onConfirm) {
                    Elements.modalConfirm.onclick = () => {
                        onConfirm();
                        this.hide();
                    };
                    Elements.modalConfirm.classList.remove('hidden');
                } else {
                    Elements.modalConfirm.classList.add('hidden');
                }
                
                // ç‚¹å‡»é®ç½©å±‚å…³é—­
                Elements.modalContainer.onclick = (e) => {
                    if (e.target === Elements.modalContainer) {
                        this.hide();
                    }
                };
            },
            
            hide() {
                Elements.modalContainer.classList.add('hidden');
                Elements.modalConfirm.onclick = null;
            },
            
            init() {
                Elements.modalClose.onclick = () => this.hide();
            }
        };

        // æ¨±èŠ±åŠ¨ç”»
        const SakuraAnimation = {
            canvas: null,
            ctx: null,
            particles: [],
            animationId: null,
            isRunning: false,
            
            init() {
                this.canvas = document.getElementById('sakura-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                
                // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', Utils.debounce(() => this.resize(), 250));
                
                // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æš‚åœ/æ¢å¤åŠ¨ç”»
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.stop();
                    } else {
                        this.start();
                    }
                });
            },
            
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            },
            
            createParticles(count = 15) {
                this.particles = [];
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height - this.canvas.height,
                        size: Math.random() * 5 + 2,
                        speedX: Math.random() * 1 - 0.5,
                        speedY: Math.random() * 0.5 + 0.5,
                        angle: Math.random() * 360,
                        spin: Math.random() * 2 - 1
                    });
                }
            },
            
            drawParticle(particle) {
                this.ctx.save();
                this.ctx.translate(particle.x, particle.y);
                this.ctx.rotate(particle.angle * Math.PI / 180);
                
                // ç»˜åˆ¶èŠ±ç“£
                this.ctx.fillStyle = '#ffb7c5';
                this.ctx.beginPath();
                this.ctx.ellipse(0, 0, particle.size, particle.size / 2, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                this.ctx.restore();
            },
            
            updateParticle(particle) {
                particle.x += particle.speedX;
                particle.y += particle.speedY;
                particle.angle += particle.spin;
                
                // ç²’å­è¶…å‡ºå±å¹•åé‡ç½®
                if (particle.y > this.canvas.height) {
                    particle.y = -10;
                    particle.x = Math.random() * this.canvas.width;
                }
                
                if (particle.x > this.canvas.width) particle.x = 0;
                if (particle.x < 0) particle.x = this.canvas.width;
            },
            
            animate() {
                if (!this.isRunning) return;
                
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // æ›´æ–°å’Œç»˜åˆ¶æ‰€æœ‰ç²’å­
                this.particles.forEach(particle => {
                    this.updateParticle(particle);
                    this.drawParticle(particle);
                });
                
                // ç»§ç»­åŠ¨ç”»
                this.animationId = requestAnimationFrame(() => this.animate());
            },
            
            start() {
                if (this.isRunning) return;
                
                this.isRunning = true;
                if (this.particles.length === 0) {
                    this.createParticles();
                }
                this.animate();
                
                // æ€§èƒ½ç›‘æ§ï¼šå¦‚æœå¸§ç‡è¿‡ä½ï¼Œå‡å°‘ç²’å­æ•°é‡
                setTimeout(() => {
                    if (this.particles.length > 10) {
                        const fps = this.getFPS();
                        if (fps < 30) {
                            this.particles = this.particles.slice(0, 10);
                        }
                    }
                }, 5000);
            },
            
            stop() {
                this.isRunning = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            },
            
            getFPS() {
                // ç®€åŒ–çš„FPSè®¡ç®—
                return 60; // å®é™…åº”è¯¥å®ç°å¸§ç‡è®¡ç®—
            }
        };

        // ä¸»åŠŸèƒ½
        const App = {
            async init() {
                console.log('åº”ç”¨åˆå§‹åŒ–...');
                
                // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
                Modal.init();
                SakuraAnimation.init();
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                this.setupEventListeners();
                
                // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
                this.setupNetworkListener();
                
                // åŠ è½½ç¼“å­˜çš„ç»Ÿè®¡ä¿¡æ¯
                this.loadCachedInfo();
                
                // è·å–æœ€æ–°ä¿¡æ¯
                await this.fetchLatestInfo();
                
                // å¯åŠ¨æ¨±èŠ±åŠ¨ç”»
                SakuraAnimation.start();
                
                // æ™ºèƒ½è®¾å¤‡è¯†åˆ«
                this.autoHighlight();
                
                console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
            },
            
            setupEventListeners() {
                // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                Elements.btnIos.addEventListener('click', () => this.importShadowrocket());
                Elements.btnAndroid.addEventListener('click', () => this.importClash('fast'));
                Elements.btnBackup.addEventListener('click', () => this.importClash('convert'));
                Elements.copyBtn.addEventListener('click', () => this.copySubscriptionLink());
                Elements.copyLinkAgain.addEventListener('click', () => this.copySubscriptionLink());
                
                // éšç§æ”¿ç­–å’ŒæœåŠ¡æ¡æ¬¾
                document.getElementById('privacy-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showPrivacyPolicy();
                });
                
                document.getElementById('tos-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showTermsOfService();
                });
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + C å¤åˆ¶è®¢é˜…é“¾æ¥
                    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                        e.preventDefault();
                        this.copySubscriptionLink();
                    }
                    
                    // ESC å…³é—­æ¨¡æ€æ¡†
                    if (e.key === 'Escape') {
                        Modal.hide();
                    }
                });
            },
            
            setupNetworkListener() {
                window.addEventListener('online', () => {
                    State.isOnline = true;
                    Elements.connectionStatus.textContent = 'åŠ å¯†è¿æ¥å·²æ¢å¤';
                    Utils.showMessage('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
                    
                    // é‡æ–°è·å–ä¿¡æ¯
                    this.fetchLatestInfo();
                });
                
                window.addEventListener('offline', () => {
                    State.isOnline = false;
                    Elements.connectionStatus.textContent = 'ç½‘ç»œè¿æ¥å·²æ–­å¼€';
                    Utils.showMessage('ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'warning');
                });
            },
            
            loadCachedInfo() {
                // åŠ è½½ç¼“å­˜çš„èŠ‚ç‚¹æ•°é‡
                const cachedCount = State.getCachedNodeCount();
                if (cachedCount !== null) {
                    State.nodeCount = cachedCount;
                    this.updateNodeCountDisplay(cachedCount);
                }
                
                // åŠ è½½ç¼“å­˜çš„ä¸Šæ¬¡æ›´æ–°æ—¶é—´
                const cachedTime = State.getCachedUpdateTime();
                if (cachedTime) {
                    this.updateLastUpdateDisplay(cachedTime);
                }
            },
            
            async fetchLatestInfo() {
                if (State.isLoading || !State.isOnline) return;
                
                State.isLoading = true;
                Elements.nodeLoading.classList.remove('hidden');
                
                try {
                    // å¹¶è¡Œè·å–èŠ‚ç‚¹æ•°é‡å’Œæ›´æ–°æ—¶é—´
                    await Promise.all([
                        this.fetchNodeCount(),
                        this.fetchLastUpdateTime()
                    ]);
                    
                    // éªŒè¯è®¢é˜…é“¾æ¥æœ‰æ•ˆæ€§
                    await this.validateSubscription();
                    
                } catch (error) {
                    console.error('è·å–ä¿¡æ¯å¤±è´¥:', error);
                    Utils.showMessage('ä¿¡æ¯æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                } finally {
                    State.isLoading = false;
                    Elements.nodeLoading.classList.add('hidden');
                }
            },
            
            async fetchNodeCount() {
                try {
                    const response = await fetch(State.subscriptionUrl, {
                        cache: 'no-cache',
                        headers: {
                            'Pragma': 'no-cache',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (!response.ok) throw new Error('è·å–è®¢é˜…å¤±è´¥');
                    
                    const text = await response.text();
                    const count = (text.match(/- name:/g) || []).length;
                    
                    State.updateNodeCount(count);
                    this.updateNodeCountDisplay(count);
                    
                } catch (error) {
                    console.warn('è·å–èŠ‚ç‚¹æ•°é‡å¤±è´¥:', error);
                    // å¦‚æœç½‘ç»œå¤±è´¥ä½†æœ‰ç¼“å­˜ï¼Œä½¿ç”¨ç¼“å­˜å€¼
                    if (State.nodeCount > 0) {
                        this.updateNodeCountDisplay(State.nodeCount);
                    } else {
                        Elements.nodeCountText.textContent = 'è·å–å¤±è´¥';
                    }
                }
            },
            
            async fetchLastUpdateTime() {
                try {
                    const response = await fetch(Config.getGitHubApiUrl(), {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 403) {
                            console.warn('GitHub APIé™åˆ¶');
                            throw new Error('APIé™åˆ¶');
                        }
                        throw new Error('è·å–æ›´æ–°æ—¶é—´å¤±è´¥');
                    }
                    
                    const commits = await response.json();
                    if (commits[0]) {
                        const updateTime = new Date(commits[0].commit.committer.date);
                        State.updateLastUpdate(updateTime);
                        this.updateLastUpdateDisplay(updateTime);
                    }
                    
                } catch (error) {
                    console.warn('è·å–æ›´æ–°æ—¶é—´å¤±è´¥:', error);
                    Elements.updateTime.textContent = 'æ—¶é—´æœªçŸ¥';
                }
            },
            
            async validateSubscription() {
                const isValid = await Utils.validateSubscription(State.subscriptionUrl);
                
                if (isValid) {
                    Elements.serverStatus.querySelector('span').textContent = 'æœåŠ¡å™¨æ­£å¸¸';
                    Elements.serverStatus.querySelector('.status-dot').className = 'status-dot status-online';
                } else {
                    Elements.serverStatus.querySelector('span').textContent = 'æœåŠ¡å™¨å¼‚å¸¸';
                    Elements.serverStatus.querySelector('.status-dot').className = 'status-dot status-warning';
                    Utils.showMessage('è®¢é˜…é“¾æ¥éªŒè¯å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•', 'warning');
                }
            },
            
            updateNodeCountDisplay(count) {
                Elements.nodeCountText.textContent = `ğŸ“Š å½“å‰è¡¥ç»™: ${count} ä¸ªèŠ‚ç‚¹`;
                Elements.nodeCount.classList.remove('bg-pink-100');
                Elements.nodeCount.classList.add('bg-green-100', 'text-green-600');
                Elements.nodeCount.querySelector('.loading').classList.add('hidden');
            },
            
            updateLastUpdateDisplay(time) {
                Elements.updateTime.textContent = `ğŸ•’ ${Utils.formatTime(time)}å·²è¡¥è´§`;
            },
            
            autoHighlight() {
                const ua = navigator.userAgent.toLowerCase();
                
                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                Elements.btnIos.classList.remove('recommend-active');
                Elements.btnAndroid.classList.remove('recommend-active');
                
                if (/iphone|ipad|ipod/.test(ua)) {
                    Elements.btnIos.classList.add('recommend-active');
                    Elements.btnIos.setAttribute('aria-label', 'ä¸€é”®å¯¼å…¥å°ç«ç®­ï¼ˆæ¨èç»™å½“å‰è®¾å¤‡ï¼‰');
                } else if (/android/.test(ua)) {
                    Elements.btnAndroid.classList.add('recommend-active');
                    Elements.btnAndroid.setAttribute('aria-label', 'ä¸€é”®å¯¼å…¥Clashï¼ˆæ¨èç»™å½“å‰è®¾å¤‡ï¼‰');
                }
            },
            
            async importShadowrocket() {
                try {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const originalText = Elements.btnIos.innerHTML;
                    Elements.btnIos.innerHTML = '<span class="loading mr-2"></span>å¯¼å…¥ä¸­...';
                    Elements.btnIos.disabled = true;
                    
                    // éªŒè¯è®¢é˜…é“¾æ¥
                    const isValid = await Utils.validateSubscription(State.subscriptionUrl);
                    if (!isValid) {
                        throw new Error('è®¢é˜…é“¾æ¥æ— æ•ˆ');
                    }
                    
                    // æ„å»ºShadowrocketé“¾æ¥
                    const encodedUrl = Utils.encodeBase64(State.subscriptionUrl);
                    const shadowrocketUrl = `shadowrocket://add/sub://${encodedUrl}?remark=é­”æ³•è¡¥ç»™ç«™`;
                    
                    // å°è¯•è·³è½¬
                    window.location.href = shadowrocketUrl;
                    
                    // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                    setTimeout(() => {
                        Modal.show(
                            'å¯¼å…¥æç¤º',
                            'å¦‚æœæœªè‡ªåŠ¨è·³è½¬åˆ°å°ç«ç®­ï¼Œè¯·ç¡®ä¿å·²å®‰è£…Shadowrocketæˆ–Quantumult Xåº”ç”¨ã€‚æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨"ä»…å¤åˆ¶è®¢é˜…é“¾æ¥"åŠŸèƒ½æ‰‹åŠ¨å¯¼å…¥ã€‚',
                            () => {
                                Elements.linkDisplay.classList.remove('hidden');
                                Elements.subscriptionLink.textContent = State.subscriptionUrl;
                            }
                        );
                    }, 1500);
                    
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    Utils.showMessage('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è®¢é˜…é“¾æ¥', 'error');
                    
                    Modal.show(
                        'å¯¼å…¥å¤±è´¥',
                        `å¯¼å…¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${error.message}\n\nè¯·å°è¯•ä»¥ä¸‹è§£å†³æ–¹æ¡ˆï¼š\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. ç¡®ä¿å·²å®‰è£…å¯¹åº”åº”ç”¨\n3. ä½¿ç”¨å¤‡ç”¨çº¿è·¯å¯¼å…¥`,
                        () => {
                            this.importClash('convert');
                        }
                    );
                    
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    setTimeout(() => {
                        Elements.btnIos.innerHTML = originalText;
                        Elements.btnIos.disabled = false;
                    }, 2000);
                }
            },
            
            async importClash(mode) {
                try {
                    const targetButton = mode === 'convert' ? Elements.btnBackup : Elements.btnAndroid;
                    const originalText = targetButton.innerHTML;
                    
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    targetButton.innerHTML = '<span class="loading mr-2"></span>å¯¼å…¥ä¸­...';
                    targetButton.disabled = true;
                    
                    // æ„å»ºClashé“¾æ¥
                    let finalUrl;
                    if (mode === 'fast') {
                        // ç›´è¿æ¨¡å¼
                        finalUrl = `${State.subscriptionUrl}?t=${Date.now()}`;
                    } else {
                        // å¤‡ç”¨è½¬æ¢æ¨¡å¼
                        finalUrl = `https://sub.id9.cc/sub?target=clash&url=${encodeURIComponent(State.subscriptionUrl)}&new_name=Magic_Station`;
                        
                        // è­¦å‘Šç”¨æˆ·ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡
                        Modal.show(
                            'ä½¿ç”¨ç¬¬ä¸‰æ–¹è½¬æ¢æœåŠ¡',
                            'æ‚¨æ­£åœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹è®¢é˜…è½¬æ¢æœåŠ¡ã€‚è¯·æ³¨æ„ï¼š\n\n1. ç¬¬ä¸‰æ–¹æœåŠ¡å¯èƒ½è®°å½•æ‚¨çš„è®¢é˜…ä¿¡æ¯\n2. å»ºè®®ä½¿ç”¨è‡ªå»ºè½¬æ¢æœåŠ¡ä»¥ç¡®ä¿å®‰å…¨\n3. æˆ‘ä»¬æ— æ³•ä¿è¯ç¬¬ä¸‰æ–¹æœåŠ¡çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§\n\næ˜¯å¦ç»§ç»­ï¼Ÿ',
                            () => {
                                // ç”¨æˆ·ç¡®è®¤åç»§ç»­
                                this.performClashImport(finalUrl);
                            }
                        );
                        return;
                    }
                    
                    await this.performClashImport(finalUrl);
                    
                } catch (error) {
                    console.error('Clashå¯¼å…¥å¤±è´¥:', error);
                    Utils.showMessage('å¯¼å…¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                    
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    setTimeout(() => {
                        const targetButton = mode === 'convert' ? Elements.btnBackup : Elements.btnAndroid;
                        targetButton.innerHTML = originalText;
                        targetButton.disabled = false;
                    }, 2000);
                }
            },
            
            async performClashImport(url) {
                // éªŒè¯é“¾æ¥
                const isValid = await Utils.validateSubscription(url);
                if (!isValid) {
                    throw new Error('è®¢é˜…é“¾æ¥æ— æ•ˆ');
                }
                
                // è·³è½¬åˆ°Clash
                window.location.href = `clash://install-config?url=${encodeURIComponent(url)}`;
                
                // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                setTimeout(() => {
                    Modal.show(
                        'å¯¼å…¥æç¤º',
                        'å¦‚æœæœªè‡ªåŠ¨è·³è½¬åˆ°Clashï¼Œè¯·ç¡®ä¿å·²å®‰è£…Clash for Windowsæˆ–Clash for Androidã€‚\n\næ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ·»åŠ è®¢é˜…é“¾æ¥ï¼š',
                        () => {
                            Elements.linkDisplay.classList.remove('hidden');
                            Elements.subscriptionLink.textContent = url;
                        }
                    );
                }, 1500);
            },
            
            async copySubscriptionLink() {
                try {
                    const success = await Utils.copyToClipboard(State.subscriptionUrl);
                    
                    if (success) {
                        // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                        Elements.copyBtn.innerHTML = 'âœ… å¤åˆ¶æˆåŠŸ';
                        Elements.copyLinkAgain.innerHTML = 'âœ… å·²å¤åˆ¶';
                        
                        // æ˜¾ç¤ºé“¾æ¥
                        Elements.linkDisplay.classList.remove('hidden');
                        Elements.subscriptionLink.textContent = State.subscriptionUrl;
                        
                        Utils.showMessage('è®¢é˜…é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                        
                        // 3ç§’åæ¢å¤æŒ‰é’®æ–‡æœ¬
                        setTimeout(() => {
                            Elements.copyBtn.innerHTML = 'ğŸ“‹ ä»…å¤åˆ¶è®¢é˜…é“¾æ¥';
                        }, 3000);
                    } else {
                        throw new Error('å¤åˆ¶å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('å¤åˆ¶å¤±è´¥:', error);
                    
                    // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºé“¾æ¥è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
                    Elements.linkDisplay.classList.remove('hidden');
                    Elements.subscriptionLink.textContent = State.subscriptionUrl;
                    
                    Modal.show(
                        'å¤åˆ¶å¤±è´¥',
                        'è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶ä¸Šé¢çš„è®¢é˜…é“¾æ¥ã€‚',
                        () => {
                            // é€‰ä¸­æ–‡æœ¬
                            const range = document.createRange();
                            range.selectNodeContents(Elements.subscriptionLink);
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                        }
                    );
                }
            },
            
            showPrivacyPolicy() {
                Modal.show(
                    'éšç§æ”¿ç­–',
                    'æˆ‘ä»¬é«˜åº¦é‡è§†æ‚¨çš„éšç§å®‰å…¨ï¼š\n\n' +
                    '1. æˆ‘ä»¬ä¸ä¼šæ”¶é›†æˆ–å­˜å‚¨æ‚¨çš„ä»»ä½•ä¸ªäººä¿¡æ¯\n' +
                    '2. è®¢é˜…é“¾æ¥é€šè¿‡åŠ å¯†CDNä¼ è¾“\n' +
                    '3. é¡µé¢è¿è¡Œåœ¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ ä»»ä½•æ•°æ®\n' +
                    '4. ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡æ—¶è¯·æ³¨æ„å…¶éšç§æ”¿ç­–\n\n' +
                    'å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æˆ‘ä»¬ã€‚'
                );
            },
            
            showTermsOfService() {
                Modal.show(
                    'æœåŠ¡æ¡æ¬¾',
                    'ä½¿ç”¨æœ¬æœåŠ¡å‰è¯·çŸ¥æ‚‰ï¼š\n\n' +
                    '1. æœ¬æœåŠ¡ä»…æä¾›æŠ€æœ¯æ”¯æŒï¼Œä¸æä¾›å®è´¨å†…å®¹\n' +
                    '2. è¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„ä½¿ç”¨æœ¬æœåŠ¡\n' +
                    '3. æˆ‘ä»¬ä¸å¯¹ç¬¬ä¸‰æ–¹æœåŠ¡å†…å®¹è´Ÿè´£\n' +
                    '4. æœåŠ¡å¯èƒ½å› ä¸å¯æŠ—åŠ›å› ç´ ä¸­æ–­\n' +
                    '5. ä¿ç•™éšæ—¶ä¿®æ”¹æœåŠ¡æ¡æ¬¾çš„æƒåˆ©\n\n' +
                    'ç»§ç»­ä½¿ç”¨å³è¡¨ç¤ºæ‚¨åŒæ„ä»¥ä¸Šæ¡æ¬¾ã€‚'
                );
            }
        };

        // é”™è¯¯è¾¹ç•Œå¤„ç†
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            
            // ä¸æ˜¾ç¤ºè¯­æ³•é”™è¯¯ç»™ç”¨æˆ·
            if (event.error instanceof SyntaxError) return;
            
            // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
            Modal.show(
                'ç³»ç»Ÿé”™è¯¯',
                'æŠ±æ­‰ï¼Œåº”ç”¨ç¨‹åºé‡åˆ°äº†é”™è¯¯ã€‚\n\n' +
                'å»ºè®®æ‚¨ï¼š\n' +
                '1. åˆ·æ–°é¡µé¢é‡è¯•\n' +
                '2. æ£€æŸ¥ç½‘ç»œè¿æ¥\n' +
                '3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜\n\n' +
                'é”™è¯¯è¯¦æƒ…ï¼š' + event.message
            );
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            
            Modal.show(
                'è¯·æ±‚å¤±è´¥',
                'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚\n\n' +
                'å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·ç¨åå†è¯•ã€‚'
            );
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => App.init());
        } else {
            App.init();
        }

        // é¡µé¢å¸è½½å‰æ¸…ç†
        window.addEventListener('beforeunload', () => {
            SakuraAnimation.stop();
        });

        // Service Worker æ³¨å†Œï¼ˆå¦‚æœæ”¯æŒï¼‰
        if ('serviceWorker' in navigator && location.protocol === 'https:') {
            navigator.serviceWorker.register('/sw.js').catch(err => {
                console.log('Service Worker æ³¨å†Œå¤±è´¥:', err);
            });
        }
    </script>
</body>
</html>